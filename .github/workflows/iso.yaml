name: Real-Time Automated ISO (Final Build + Auto-Reboot)
on: 
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Fast Binary Setup (Nitro Parallel)
        run: |
          mkdir -p xorriso_bin/usr
          cd xorriso_bin
          BASE_URL="http://azure.archive.ubuntu.com/ubuntu/pool/main"
          aria2c -x 16 -s 16 -k 1M \
            "${BASE_URL}/libi/libisoburn/xorriso_1.5.6-1.1ubuntu3_amd64.deb" \
            "${BASE_URL}/libi/libisoburn/libisoburn1t64_1.5.6-1.1ubuntu3_amd64.deb" \
            "${BASE_URL}/libi/libisofs/libisofs6t64_1.5.6.pl01-1.1ubuntu2_amd64.deb" \
            "${BASE_URL}/libb/libburn/libburn4t64_1.5.6-1.1build1_amd64.deb"
          
          for f in *.deb; do
            (
              mkdir -p "tmp_$f" && cd "tmp_$f"
              ar x "../$f"
              DATA_ARCHIVE=$(ls data.tar.*)
              tar --use-compress-program=zstd -xf "$DATA_ARCHIVE" || tar -xf "$DATA_ARCHIVE"
              cp -r usr/* ../usr/
            ) &
          done
          wait
          echo "$(pwd)/usr/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=$(pwd)/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Parallel ISO Download
        run: |
          URL="https://releases.ubuntu.com/24.04.1/ubuntu-24.04.1-live-server-amd64.iso"
          aria2c -x 16 -s 16 -k 1M "$URL" -o official.iso

      - name: Fetch SSH Keys & Patch ISO
        run: |
          SSH_KEYS=$(curl -s https://github.com/vowywowy.keys)
          mkdir -p nocloud
          cat <<EOF > nocloud/user-data
          #cloud-config
          autoinstall:
            version: 1
            storage: {layout: {name: direct}}
            identity: 
              hostname: ai
              username: ubuntu
              password: "!"
            ssh:
              install-server: true
              authorized-keys:
          $(echo "$SSH_KEYS" | sed 's/^/                - /')
            package_update: true
            package_upgrade: true
            apt:
              sources:
                docker.list:
                  source: "deb [arch=amd64] https://download.docker.com/linux/ubuntu noble stable"
                  keyid: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88
            packages:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
              - unattended-upgrades
              - linux-generic
            user-data:
              sudo: ALL=(ALL) NOPASSWD:ALL
            late-commands:
              - curtin in-target -- usermod -aG docker ubuntu
              - curtin in-target -- systemctl enable unattended-upgrades
              - curtin in-target -- dpkg-reconfigure -f noninteractive unattended-upgrades
          EOF
          touch nocloud/meta-data

          7z e official.iso boot/grub/grub.cfg -ogrub_patch
          sed -i 's/---/ autoinstall  ---/g' grub_patch/grub.cfg

          xorriso -indev official.iso \
            -outdev custom-ubuntu.iso \
            -map nocloud/user-data /user-data \
            -map nocloud/meta-data /meta-data \
            -map grub_patch/grub.cfg /boot/grub/grub.cfg \
            -boot_image any replay \
            -changes_pending yes

      - name: ‚ö° Upload Flash Script
        uses: actions/upload-artifact@v4
        with:
          name: flash-script
          path: Flash-UbuntuUSB.ps1

      - name: üêò Upload Custom ISO
        uses: actions/upload-artifact@v4
        with:
          name: custom-ubuntu-iso
          path: custom-ubuntu.iso
          compression-level: 0
