name: Real-Time Automated ISO (1st Party Only)
on: 
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install System Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y xorriso aria2 -qq

      - name: Parallel Download
        run: |
          URL="https://releases.ubuntu.com/24.04.1/ubuntu-24.04.1-live-server-amd64.iso"
          aria2c -x 16 -s 16 -k 1M "$URL" -o official.iso

      - name: Build & Patch in RAM
        run: |
          mkdir -p nocloud
          cat <<EOF > nocloud/user-data
          #cloud-config
          autoinstall:
            version: 1
            storage: {layout: {name: direct}}
            identity: {hostname: ubuntu-server, username: ubuntu, password: "!"}
            ssh: {install-server: true, allow-pw: false}
            user-data:
              ssh_import_id: [gh:vowywowy]
              sudo: ALL=(ALL) NOPASSWD:ALL
          EOF
          osirrox -indev official.iso -extract /boot/grub/grub.cfg grub_modified.cfg
          sed -i 's/---/ autoinstall  ---/g' grub_modified.cfg

          xorriso -indev official.iso \
            -outdev custom-ubuntu.iso \
            -map nocloud/user-data /user-data \
            -map grub_modified.cfg /boot/grub/grub.cfg \
            -boot_image any replay \
            -changes_pending yes

      - name: Generate PowerShell Burn Script
        run: |
          cat <<'EOF' > Flash-UbuntuUSB.ps1
          $ISO = "custom-ubuntu.iso"
          Write-Host "--- Flashing Phase ---" -ForegroundColor Cyan
          Get-Disk | Where-Object BusType -eq 'USB' | Select-Object Number, FriendlyName, Size
          $DiskNumber = Read-Host "Enter the DISK NUMBER of your USB drive"
          $TargetDisk = Get-Disk -Number $DiskNumber
          Write-Host "WARNING: This will WIPE ALL DATA on $($TargetDisk.FriendlyName). Continue? (Y/N)" -ForegroundColor Yellow
          if ((Read-Host) -ne "Y") { exit }
          Clear-Disk -Number $DiskNumber -RemoveData -Confirm:$false
          Initialize-Disk -Number $DiskNumber -PartitionStyle GPT
          $Part = New-Partition -DiskNumber $DiskNumber -UseMaximumSize -AssignDriveLetter
          $DriveLetter = ($Part | Format-Volume -FileSystem FAT32 -NewFileSystemLabel "UBUNTU").DriveLetter
          $Mounted = Mount-DiskImage -ImagePath (Get-Item $ISO).FullName -PassThru
          $ISODrive = ($Mounted | Get-Volume).DriveLetter
          xcopy "$($ISODrive):\*" "$($DriveLetter):\" /E /H /F
          Dismount-DiskImage -ImagePath (Get-Item $ISO).FullName
          Write-Host "Successfully created bootable USB!" -ForegroundColor Green
          EOF

      - name: Upload ISO as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: custom-ubuntu-iso
          path: custom-ubuntu.iso
          compression-level: 0 # Faster upload, no extra zipping

      - name: Upload Burn Script as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: flash-script
          path: Flash-UbuntuUSB.ps1

      - name: Output Summary
        run: |
          echo "### ðŸš€ ISO Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "GitHub Release has a 2GB limit, so the 2.6GB ISO is stored in **Artifacts**." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to the **Summary** tab of this run." >> $GITHUB_STEP_SUMMARY
          echo "2. Download \`custom-ubuntu-iso\` (Artifacts section at the bottom)." >> $GITHUB_STEP_SUMMARY
          echo "3. Download \`flash-script\`." >> $GITHUB_STEP_SUMMARY
