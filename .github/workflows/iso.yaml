name: Build Custom Ubuntu ISO (Ultra Optimized)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-iso:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      actions: write
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Cache Xorriso Binaries
        id: cache-xorriso
        uses: actions/cache@v4
        with:
          path: /dev/shm/xorriso_bin
          key: xorriso-v4 # Incremented key

      - name: Integrated Build and Upload
        run: |
          cd /dev/shm
          
          # 1. Setup Xorriso (Fixed Multi-Download)
          if [ "${{ steps.cache-xorriso.outputs.cache-hit }}" != "true" ]; then
            mkdir -p xorriso_bin/usr/lib/x86_64-linux-gnu
            cd xorriso_bin
            
            # Explicitly listing URLs to ensure aria2c catches all 4
            BASE="http://azure.archive.ubuntu.com/ubuntu/pool/main"
            echo "${BASE}/libi/libisoburn/xorriso_1.5.6-1.1ubuntu3_amd64.deb" > list.txt
            echo "${BASE}/libi/libisoburn/libisoburn1t64_1.5.6-1.1ubuntu3_amd64.deb" >> list.txt
            echo "${BASE}/libi/libisofs/libisofs6t64_1.5.6.pl01-1.1ubuntu2_amd64.deb" >> list.txt
            echo "${BASE}/libb/libburn/libburn4t64_1.5.6-1.1build1_amd64.deb" >> list.txt
            
            aria2c -x 16 -s 16 -i list.txt
            
            for f in *.deb; do ar x "$f" && tar -xf data.tar.*; done
            
            cd usr/lib/x86_64-linux-gnu
            ln -sf libisoburn.so.1.* libisoburn.so.1
            ln -sf libisofs.so.6.* libisofs.so.6
            ln -sf libburn.so.4.* libburn.so.4
            cd /dev/shm
          fi

          # 2. Path Exports
          export PATH="$(pwd)/xorriso_bin/usr/bin:$PATH"
          export LD_LIBRARY_PATH="$(pwd)/xorriso_bin/usr/lib/x86_64-linux-gnu"

          # 3. ISO Download & Patching
          aria2c -x 16 -s 16 -k 1M "https://releases.ubuntu.com/24.04.1/ubuntu-24.04.1-live-server-amd64.iso" -o official.iso
          
          SSH_KEYS=$(curl -s https://github.com/vowywowy.keys)
          mkdir -p nocloud grub_patch
          cat <<EOF > nocloud/user-data
          #cloud-config
          autoinstall:
            version: 1
            storage: {layout: {name: direct}}
            identity: {hostname: ai, username: ubuntu, password: "!"}
            ssh:
              install-server: true
              authorized-keys:
          $(echo "$SSH_KEYS" | sed 's/^/      - /')
            packages: [docker-ce, docker-ce-cli, containerd.io, docker-buildx-plugin, docker-compose-plugin, unattended-upgrades, linux-generic]
            user-data: {sudo: "ALL=(ALL) NOPASSWD:ALL"}
            late-commands:
              - curtin in-target -- usermod -aG docker ubuntu
              - reboot
          EOF

          7z e official.iso boot/grub/grub.cfg -ogrub_patch
          sed -i 's/---/ autoinstall  ---/g' grub_patch/grub.cfg

          # 4. Build ISO
          xorriso -indev official.iso \
            -outdev custom-ubuntu-24.04.iso \
            -map nocloud/user-data /user-data \
            -map /dev/null /meta-data \
            -map grub_patch/grub.cfg /boot/grub/grub.cfg \
            -boot_image any replay \
            -changes_pending yes

          # 5. Upload via GH CLI
          gh run upload ${{ github.run_id }} custom-ubuntu-24.04.iso
