name: Real-Time Automated ISO (1st Party Only)
on: 
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Fast Binary Setup (No Apt Update)
        run: |
          # Download xorriso and dependencies directly as .deb files
          # This takes ~2 seconds vs ~60 seconds for apt update
          mkdir -p xorriso_bin
          cd xorriso_bin
          BASE_URL="http://azure.archive.ubuntu.com/ubuntu/pool/main/libi/libisoburn"
          aria2c -x 16 -s 16 -k 1M "${BASE_URL}/xorriso_1.5.6-1.1ubuntu3_amd64.deb"
          aria2c -x 16 -s 16 -k 1M "${BASE_URL}/libisoburn1t64_1.5.6-1.1ubuntu3_amd64.deb"
          aria2c -x 16 -s 16 -k 1M "http://azure.archive.ubuntu.com/ubuntu/pool/main/libi/libisofs/libisofs6t64_1.5.6.pl01-1.1ubuntu2_amd64.deb"
          aria2c -x 16 -s 16 -k 1M "http://azure.archive.ubuntu.com/ubuntu/pool/main/libb/libburn/libburn4t64_1.5.6-1.1build1_amd64.deb"
          
          # Manually extract the binaries and libs
          for f in *.deb; do ar x $f; tar -xf data.tar.xz; done
          
          # Add to PATH and LD_LIBRARY_PATH
          echo "$(pwd)/usr/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=$(pwd)/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Parallel ISO Download
        run: |
          URL="https://releases.ubuntu.com/24.04.1/ubuntu-24.04.1-live-server-amd64.iso"
          aria2c -x 16 -s 16 -k 1M "$URL" -o official.iso

      - name: Patch & Repack (100% Automated)
        run: |
          mkdir -p nocloud
          cat <<EOF > nocloud/user-data
          #cloud-config
          autoinstall:
            version: 1
            storage: {layout: {name: direct}}
            identity: {hostname: ubuntu-server, username: ubuntu, password: "!"}
            ssh: {install-server: true, allow-pw: false}
            user-data:
              ssh_import_id: [gh:vowywowy]
              sudo: ALL=(ALL) NOPASSWD:ALL
          EOF
          touch nocloud/meta-data

          # Use 7z (pre-installed) to grab just the boot config
          7z e official.iso boot/grub/grub.cfg -ogrub_patch
          sed -i 's/---/ autoinstall  ---/g' grub_patch/grub.cfg

          # Build the ISO using the 'overlay' method
          xorriso -indev official.iso \
            -outdev custom-ubuntu.iso \
            -map nocloud/user-data /user-data \
            -map nocloud/meta-data /meta-data \
            -map grub_patch/grub.cfg /boot/grub/grub.cfg \
            -boot_image any replay \
            -changes_pending yes

      - name: Generate Smart PowerShell Burn Script
        run: |
          cat <<'EOF' > Flash-UbuntuUSB.ps1
          $ZipFile = Get-ChildItem -Filter "custom-ubuntu-iso.zip" | Select-Object -First 1
          $ISO = "custom-ubuntu.iso"
          if ($ZipFile) {
              Write-Host "Detected ZIP. Extracting..." -ForegroundColor Cyan
              Expand-Archive -Path $ZipFile.FullName -DestinationPath $PSScriptRoot -Force
          }
          Write-Host "--- Flashing Phase ---" -ForegroundColor Cyan
          Get-Disk | Where-Object BusType -eq 'USB' | Select-Object Number, FriendlyName, Size
          $DiskNumber = Read-Host "Enter the DISK NUMBER of your USB drive"
          Clear-Disk -Number $DiskNumber -RemoveData -Confirm:$false
          Initialize-Disk -Number $DiskNumber -PartitionStyle GPT
          $Part = New-Partition -DiskNumber $DiskNumber -UseMaximumSize -AssignDriveLetter
          $DriveLetter = ($Part | Format-Volume -FileSystem FAT32 -NewFileSystemLabel "UBUNTU").DriveLetter
          $Mounted = Mount-DiskImage -ImagePath (Get-Item $ISO).FullName -PassThru
          $ISODrive = ($Mounted | Get-Volume).DriveLetter
          xcopy "$($ISODrive):\*" "$($DriveLetter):\" /E /H /F
          Dismount-DiskImage -ImagePath (Get-Item $ISO).FullName
          Write-Host "Success! USB is ready." -ForegroundColor Green
          EOF

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: custom-ubuntu-iso
          path: |
            custom-ubuntu.iso
            Flash-UbuntuUSB.ps1
          compression-level: 0
